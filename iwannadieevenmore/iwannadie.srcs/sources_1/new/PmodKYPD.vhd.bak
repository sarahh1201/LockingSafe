library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;

entity PmodKYPD is
    Port (
        clk        : in  STD_LOGIC;
        JA         : inout STD_LOGIC_VECTOR(7 downto 0); -- PmodKYPD port
        an         : out STD_LOGIC_VECTOR(3 downto 0);
        seg        : out STD_LOGIC_VECTOR(6 downto 0);
        enter_flag : out STD_LOGIC;
        clear_flag : out STD_LOGIC;
        key_valid  : out STD_LOGIC;
        digit      : out STD_LOGIC_VECTOR(3 downto 0)
    );
end PmodKYPD;

architecture Behavioral of PmodKYPD is

    component Decoder is
        Port (
            clk        : in  STD_LOGIC;
            Row        : in  STD_LOGIC_VECTOR(3 downto 0);
            Col        : out STD_LOGIC_VECTOR(3 downto 0);
            DecodeOut  : out STD_LOGIC_VECTOR(3 downto 0);
            enter_flag : out STD_LOGIC;
            clear_flag : out STD_LOGIC;
            input_flag : out STD_LOGIC
        );
    end component;

    component DisplayController is
        Port (
            DispVal : in  STD_LOGIC_VECTOR(3 downto 0);
            anode   : out STD_LOGIC_VECTOR(3 downto 0);
            segOut  : out STD_LOGIC_VECTOR(6 downto 0)
        );
    end component;

    signal Decode : STD_LOGIC_VECTOR(3 downto 0);
    signal Col_sig : STD_LOGIC_VECTOR(3 downto 0);

begin
    -- Drive columns
    JA(3 downto 0) <= Col_sig;

    -- Decoder
    DEC : Decoder
        port map(
            clk        => clk,
            Row        => JA(7 downto 4),
            Col        => Col_sig,
            DecodeOut  => Decode,
            enter_flag => enter_flag,
            clear_flag => clear_flag,
            input_flag => key_valid
        );

    -- Output the current digit
    digit <= Decode;

    -- Display controller
    DSP : DisplayController
        port map(
            DispVal => Decode,
            anode   => an,
            segOut  => seg
        );

end Behavioral;

