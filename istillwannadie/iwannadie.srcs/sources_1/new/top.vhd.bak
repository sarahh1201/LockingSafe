library IEEE;
architecture Structural of safe_top is

    -- Component declarations
    component PmodKYPD
        port(
            clk        : in  std_logic;
            JA         : inout std_logic_vector(7 downto 0);
            an         : out std_logic_vector(3 downto 0);
            seg        : out std_logic_vector(6 downto 0);
            enter_flag : out std_logic;
            clear_flag : out std_logic;
            key_valid  : out std_logic;
            digit      : out std_logic_vector(3 downto 0)
        );
    end component;

    component passcode_checker
        port(
            clk           : in  std_logic;
            reset         : in  std_logic;
            load          : in  std_logic;
            digit_in      : in  std_logic_vector(3 downto 0);
            passcode_flag : out std_logic
        );
    end component;

    component controller
        port(
            clk           : in  std_logic;
            reset         : in  std_logic;
            start         : in  std_logic;
            passcode_flag : in  std_logic;
            load          : out std_logic;
            done          : out std_logic;
            lock_cmd      : out std_logic;
            unlock_cmd    : out std_logic;
            alarmState    : out std_logic
        );
    end component;

    component servo
        port(
            clk      : in  std_logic;
            rst      : in  std_logic;
            lock     : in  std_logic;
            unlock   : in  std_logic;
            servoPWM : out std_logic
        );
    end component;

    component alarm
        port(
            clk        : in  std_logic;
            reset      : in  std_logic;
            alarmState : in  std_logic;
            buzzer_out : out std_logic
        );
    end component;

    -- Internal signals
    signal digit       : std_logic_vector(3 downto 0);
    signal load        : std_logic;
    signal done        : std_logic;
    signal pass_flag   : std_logic;
    signal alarmState  : std_logic;
    signal lock_cmd    : std_logic;
    signal unlock_cmd  : std_logic;
    signal enter_flag  : std_logic;
    signal clear_flag  : std_logic;
    signal key_valid   : std_logic;

begin


    ----------------------------------------------------------------
    -- 1. Keypad and Display
    ----------------------------------------------------------------
    keypad_display : entity work.PmodKYPD
        port map(
            clk        => clk,
            reset      => reset,
            JA         => JA,
            an         => an,
            seg        => seg,
            enter_flag => enter_flag,
            clear_flag => clear_flag,
            key_valid  => key_valid,
            digit      => digit
        );

    ----------------------------------------------------------------
    -- 2. Passcode Checker
    ----------------------------------------------------------------
    codeCheck : entity work.passcode_checker
        port map(
            clk           => clk,
            reset         => reset,
            load          => load,
            digit_in      => digit,
            passcode_flag => pass_flag
        );

    ----------------------------------------------------------------
    -- 3. Main Controller FSM
    ----------------------------------------------------------------
    controller_fsm : entity work.controller
        port map(
            clk           => clk,
            reset         => reset,
            start         => enter_flag, -- start on "enter" press
            passcode_flag => pass_flag,
            load          => load,
            done          => done,
            lock_cmd      => lock_cmd,
            unlock_cmd    => unlock_cmd,
            alarmState    => alarmState
        );

    ----------------------------------------------------------------
    -- 4. Servo Motor Module
    ----------------------------------------------------------------
    servo_mod : entity work.servo
        port map(
            clk      => clk,
            rst      => reset,
            lock     => lock_cmd,
            unlock   => unlock_cmd,
            servoPWM => servoPWM
        );

    ----------------------------------------------------------------
    -- 5. Alarm Module
    ----------------------------------------------------------------
    alarm_mod : entity work.alarm
        port map(
            clk        => clk,
            reset      => reset,
            alarmState => alarmState,
            buzzer_out => buzzer_out
        );

end Structural;
