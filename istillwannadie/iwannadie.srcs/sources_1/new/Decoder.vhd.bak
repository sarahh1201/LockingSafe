library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;

entity Decoder is
    Port (
        clk        : in  STD_LOGIC;
        Row        : in  STD_LOGIC_VECTOR(3 downto 0);
        Col        : out STD_LOGIC_VECTOR(3 downto 0);
        DecodeOut  : out STD_LOGIC_VECTOR(3 downto 0);
        enter_flag : out STD_LOGIC;
        clear_flag : out STD_LOGIC;
        input_flag : out STD_LOGIC
    );
end Decoder;

architecture Behavioral of Decoder is
    signal sclk       : STD_LOGIC_VECTOR(19 downto 0) := (others => '0');
    signal enter_sig  : STD_LOGIC := '0';
    signal clear_sig  : STD_LOGIC := '0';
    signal input_sig  : STD_LOGIC := '0';
begin
    process(clk)
    begin
        if rising_edge(clk) then
            sclk <= sclk + 1;

            -- Column 1 scan
            if sclk = "00011000011010100000" then
sclk <= std_logic_vector(unsigned(sclk) + 1);


                Col <= "0111"; -- drive C1
            elsif sclk = "00011000011010101000" then
                -- check row pins
                if Row = "0111" then DecodeOut <= "0001"; end if; -- 1
                if Row = "1011" then DecodeOut <= "0100"; end if; -- 4
                if Row = "1101" then DecodeOut <= "0111"; end if; -- 7
                if Row = "1110" then DecodeOut <= "0000"; end if; -- 0

            -- Column 2 scan
            elsif sclk = "00110000110101000000" then
                Col <= "1011"; -- drive C2
            elsif sclk = "00110000110101001000" then
                if Row = "0111" then DecodeOut <= "0010"; end if; -- 2
                if Row = "1011" then DecodeOut <= "0101"; end if; -- 5
                if Row = "1101" then DecodeOut <= "1000"; end if; -- 8
                if Row = "1110" then DecodeOut <= "1111"; end if; -- F

            -- Column 3 scan
            elsif sclk = "01001001001111100000" then
                Col <= "1101"; -- drive C3
            elsif sclk = "01001001001111101000" then
                if Row = "0111" then DecodeOut <= "0011"; end if; -- 3
                if Row = "1011" then DecodeOut <= "0110"; end if; -- 6
                if Row = "1101" then DecodeOut <= "1001"; end if; -- 9
                if Row = "1110" then enter_sig <= '1'; end if; -- Enter

            -- Column 4 scan
            elsif sclk = "01100001101010000000" then
                Col <= "1110"; -- drive C4
            elsif sclk = "01100001101010001000" then
                if Row = "0111" then DecodeOut <= "1010"; end if; -- A
                if Row = "1011" then clear_sig <= '1'; end if; -- C
                if Row = "1101" then DecodeOut <= "1100"; end if; -- D
                -- note: back flag removed

            else
                null; -- do nothing
            end if;

            -- assign outputs
            enter_flag <= enter_sig;
            clear_flag <= clear_sig;
            input_flag <= input_sig;

        end if;
    end process;
end Behavioral;

